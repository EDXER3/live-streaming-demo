<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>server to strat streaming</title>
	</head>
<body>
	<h1> server to strat streaming</h1>
	<video id="video" poster="live streaming.jpg" controls="true" autoplay></video>
	<canvas id="canvas" width="780" height="440"></canvas>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		(function (d, w, n, io){
			'use strict'
			
			var io = io(),
				startCamera = false,
				video = d.querySelector('#video'),
				canvas = d.querySelector('#canvas'),
				vendorUrl = (w.URL || w.webkitURL),
				context = canvas.getContext('2d')
			n.streaming = (
				navigator.getUserMedia || 
				navigator.webkitGetUserMedia || 
				navigator.mozGetUserMedia || 
				navigator.msGetUserMedia
			)
			n.streaming({
				video : true,
				audio : false
			}, function(stream){
				startCamera = true
  				//video.src = w.URL.createObjectURL(stream)
				try {
  					video.srcObject = stream
				} catch (error) {
  					video.src = vendorUrl.createObjectURL(stream)
				}
				//video.play;
				video.play
			}, function (err){
				alert('error :' + err)
			})
			
			w.playVideo = (function(cd){
				return w.requestAnimationFrame ||
					w.WebkitRequestAnimationFrame ||
					w.mozRequestAnimationFrame ||
					w.msRequestAnimationFrame ||
					function (cd){
						FPS = 60
						w.setTimeout(cd, 1000/FPS)
					}
			})()
			
			
			function streamVideo(context, canvas, video){
				
				var outputStream = canvas.toDataURL('image/jpeg',0.5)
				context.drawImage(video, 0, 0)
				
				if(startCamera){
					io.emit('streaming', outputStream)
				}
				playVideo(function(){
					streamVideo(context, canvas, video)
				})
			}
			
			w.addEventListener('load', function(){
				//video.autoplay = true
				//video.style.display = 'none'
				canvas.style.display = 'none'
				streamVideo(context, canvas, video)
			})
			
		})(document, window, navigator, io)
	</script>
		
</body>
	
</html>